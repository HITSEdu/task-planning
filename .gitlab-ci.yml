# include:
#   - local: 'ci/templates.yml'

.npm_cache:
  cache: 
    key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

.npm_base:
  image: node:24
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  before_script:
    - echo "CI_PROJECT: $CI_PROJECT_PATH"
    - echo "CI_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME"
    - node -v
    - npm -v
  variables:
    NODE_ENV: 'development'

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_REF_PROTECTED == 'true'
    - if: $CI_COMMIT_BRANCH == 'main'

stages:
  - install
  - lint
  - test
  - build
  - deploy

install:
  stage: install
  extends: .npm_base
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1h

lint:
  stage: lint
  extends: .npm_base
  needs:
    - job: install
      artifacts: true
  script:
    - npm run lint

test:
  stage: test
  extends: .npm_base
  needs:
    - job: install
      artifacts: true
  script:
    - npm test
  artifacts:
    when: always
    reports:
      junit: reports/junit/junit.xml
    paths:
      - reports/
    expire_in: 1 week

build:
  stage: build
  needs:
    - job: test
      artifacts: true
  script:
    - echo "DATABASE_URL is set ${DATABASE_URL:+yes}"
    - echo "BETTER_AUTH_SECRET is set ${BETTER_AUTH_SECRET:+yes}"
    - echo "BETTER_AUTH_URL is set ${BETTER_AUTH_URL:+yes}"
    - npm run build
  artifacts:
    paths:
      - .next/
      - node_modules/
    expire_in: 1 week

# deploy:
#   stage: deploy
#   image: node:24
#   needs:
#     - job: build
#       artifacts: true
#   when: manual
#   environment:
#     name: production
#   script:
#     - echo "DATABASE_URL is set ${DATABASE_URL:+yes}"
#     - echo "BETTER_AUTH_SECRET is set ${BETTER_AUTH_SECRET:+yes}"
#     - echo "BETTER_AUTH_URL is set ${BETTER_AUTH_URL:+yes}"
#     - npm run deploy --if-present
#   only:
#     - main
